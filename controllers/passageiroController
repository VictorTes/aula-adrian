const getPassageiro = require('../models/passageiro/consulta');
const cadastrarPassageiro = require('../models/passageiro/criar');
const TelefonePassageiroAtt = require('../models/passageiro/atualizarTelefone');
const NomePassageiroAtt = require('../models/passageiro/atualizarNome');
const deletePassageiro = require('../models/passageiro/deletar');
const Joi = require('joi');
const bcrypt = require('bcryptjs'); // ✅ trocado para bcryptjs

// --- Schemas de validação com Joi ---
const passageiroSchema = Joi.object({
  nome_passageiro: Joi.string().max(45).required(),
  cpf_passageiro: Joi.string().max(14).required(),
  email_passageiro: Joi.string().max(50).required(),
  rua_passageiro: Joi.string().max(50).required(),
  cidade_passageiro: Joi.string().max(50).required(),
  bairro_passageiro: Joi.string().max(50).required(),
  uf_passageiro: Joi.string().max(2).required(),
  senha_passageiro: Joi.string().max(50).required(),
  telefone_passageiro: Joi.string().max(20).required()
});

const passageiroUpdate = Joi.object({
  telefone_antigo: Joi.string(),
  telefone: Joi.string().max(20),
  nome_antigo: Joi.string(),
  nome: Joi.string().max(45)
});

// --- Controller ---
module.exports = {
  // Listar todos os passageiros
  listar: async function (req, res) {
    getPassageiro.listarPassageiros()
      .then(passageiros => res.json(passageiros))
      .catch(erro => {
        console.error('Erro ao listar passageiro:', erro);
        res.status(500).send('Erro ao listar passageiros');
      });
  },

  // Criar passageiro
  criar: async function (req, res) {
    const { error } = passageiroSchema.validate(req.body);

    if (error) {
      console.error('Erro de validação:', error.details);
      return res.status(400).send(`Dados inválidos: ${error.details.map(e => e.message).join(', ')}`);
    }

    try {
      const {
        nome_passageiro,
        cpf_passageiro,
        email_passageiro,
        rua_passageiro,
        cidade_passageiro,
        bairro_passageiro,
        uf_passageiro,
        senha_passageiro,
        telefone_passageiro
      } = req.body;

      // Gera hash da senha
      const salt = await bcrypt.genSalt(12);
      const passwordhash = await bcrypt.hash(senha_passageiro, salt);

      await cadastrarPassageiro.criarPassageiro(
        nome_passageiro,
        cpf_passageiro,
        email_passageiro,
        rua_passageiro,
        cidade_passageiro,
        bairro_passageiro,
        uf_passageiro,
        passwordhash,
        telefone_passageiro
      );

      res.send('Passageiro cadastrado com sucesso');
    } catch (erro) {
      console.error('Erro ao cadastrar passageiro:', erro);
      res.status(500).send('Erro ao cadastrar passageiro');
    }
  },

  // Atualizar passageiro
  atualizar: async function (req, res) {
    const { error } = passageiroUpdate.validate(req.body);

    if (error) {
      console.error('Erro de validação:', error.details);
      return res.status(400).send(`Dados inválidos: ${error.details.map(e => e.message).join(', ')}`);
    }

    const { telefone_antigo, telefone, nome_antigo, nome } = req.body;

    try {
      if (telefone_antigo && telefone && nome_antigo && nome) {
        await TelefonePassageiroAtt.atualizarTelefone(telefone, telefone_antigo, res);
        await NomePassageiroAtt.atualizarNome(nome, nome_antigo, res);
        return res.status(200).send(`Passageiro atualizado: nome ${nome}, telefone ${telefone}`);
      }

      if (telefone_antigo && telefone) {
        await TelefonePassageiroAtt.atualizarTelefone(telefone, telefone_antigo, res);
        return res.status(200).send(`Telefone atualizado para ${telefone}`);
      }

      if (nome_antigo && nome) {
        await NomePassageiroAtt.atualizarNome(nome, nome_antigo, res);
        return res.status(200).send(`Nome atualizado para ${nome}`);
      }

      res.status(400).send('Nenhum dado válido para atualizar');
    } catch (err) {
      console.error('Erro ao atualizar passageiro:', err);
      res.status(500).send('Erro ao atualizar passageiro');
    }
  },

  // Deletar passageiro
  deletar: function (req, res) {
    deletePassageiro.deletarPassageiro(req.params.id)
      .then(() => res.send('Passageiro deletado com sucesso'))
      .catch(erro => {
        console.error('Erro ao deletar passageiro:', erro);
        res.status(500).send('Erro ao deletar passageiro');
      });
  }
};
